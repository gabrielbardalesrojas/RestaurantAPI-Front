<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador - Panel de Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: white;
            color: #FF6B6B;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #FF6B6B;
            color: white;
            border-color: #FF6B6B;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn:hover {
            background: #EE5A6F;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-edit {
            background: #2196F3;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-delete {
            background: #f44336;
            padding: 6px 12px;
            font-size: 13px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f8f8;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f8f8;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .code-display {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .code-value {
            font-size: 32px;
            font-weight: 700;
            color: #FF6B6B;
            letter-spacing: 4px;
            font-family: 'Courier New', monospace;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .actions-cell {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="user-info">
                <h2>üë®‚Äçüíº Panel de Administraci√≥n</h2>
                <p id="adminInfo">Cargando...</p>
            </div>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('mesas')">ü™ë Mesas</button>
            <button class="tab-btn" onclick="showTab('empleados')">üë• Empleados</button>
            <button class="tab-btn" onclick="showTab('categorias')">üìã Categor√≠as</button>
            <button class="tab-btn" onclick="showTab('productos')">üçΩÔ∏è Productos</button>
            <button class="tab-btn" onclick="showTab('ingredientes')">ü•ó Ingredientes</button>
            <button class="tab-btn" onclick="showTab('reportes')">üìä Reportes</button>
            <button class="tab-btn" onclick="showTab('producto-ingredientes')">üîó Prod-Ingredientes</button>
        </div>

        <!-- TAB: MESAS -->
        <div class="tab-content active" id="tab-mesas">
            <div class="section-header">
                <h2>Gesti√≥n de Mesas</h2>
               <button class="btn" onclick="prepararCrear('modalCrearMesa', 'tituloModalMesa', 'Nueva Mesa')">+ Nueva Mesa</button>
            </div>
            
            <div id="alertMesas" class="alert"></div>
            <div id="codigoMesaDisplay"></div>

            <table id="tablaMesas">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>N√∫mero</th>
                        <th>C√≥digo</th>
                        <th>Capacidad</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- TAB: EMPLEADOS -->
        <div class="tab-content" id="tab-empleados">
            <div class="section-header">
                <h2>Gesti√≥n de Empleados</h2>
                <button class="btn" onclick="openModal('modalCrearEmpleado')">+ Nuevo Empleado</button>
            </div>
            
            <div id="alertEmpleados" class="alert"></div>
            <div id="codigoEmpleadoDisplay"></div>

            <table id="tablaEmpleados">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- TAB: CATEGOR√çAS -->
        <div class="tab-content" id="tab-categorias">
            <div class="section-header">
                <h2>Categor√≠as de Productos</h2>
                <button class="btn" onclick="openModal('modalCrearCategoria')">+ Nueva Categor√≠a</button>
            </div>

            <div id="alertCategorias" class="alert"></div>

            <table id="tablaCategorias">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripci√≥n</th>
                        <th>Orden</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- TAB: PRODUCTOS -->
        <div class="tab-content" id="tab-productos">
            <div class="section-header">
                <h2>Gesti√≥n de Productos</h2>
                <button class="btn" onclick="openModal('modalCrearProducto')">+ Nuevo Producto</button>
            </div>

            <div id="alertProductos" class="alert"></div>

            <table id="tablaProductos">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Categor√≠a</th>
                        <th>Precio</th>
                        <th>Disponible</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- TAB: INGREDIENTES -->
        <div class="tab-content" id="tab-ingredientes">
            <div class="section-header">
                <h2>Gesti√≥n de Ingredientes</h2>
                <button class="btn" onclick="openModal('modalCrearIngrediente')">+ Nuevo Ingrediente</button>
            </div>

            <div id="alertIngredientes" class="alert"></div>

            <table id="tablaIngredientes">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripci√≥n</th>
                        <th>Al√©rgeno</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- TAB: PRODUCTO-INGREDIENTES -->
<div class="tab-content" id="tab-producto-ingredientes">
    <div class="section-header">
        <h2>Asignar Ingredientes a Productos</h2>
        <button class="btn" onclick="openModal('modalAsignarIngrediente')">+ Asignar Ingrediente</button>
    </div>

    <div id="alertProductoIngredientes" class="alert"></div>

    <div class="form-group" style="max-width: 400px;">
        <label>Filtrar por Producto</label>
        <select id="filtroProducto" onchange="filtrarAsignaciones()">
            <option value="">Todos los productos</option>
        </select>
    </div>

    <table id="tablaProductoIngredientes">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Ingrediente</th>
                <th>Cantidad</th>
                <th>Al√©rgeno</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

        <!-- TAB: REPORTES -->
        <div class="tab-content" id="tab-reportes">
            <h2>Reportes del D√≠a</h2>
            
            <div class="form-group" style="max-width: 300px;">
                <label>Seleccionar Fecha</label>
                <input type="date" id="fechaReporte">
                <button class="btn" onclick="cargarReporte()" style="margin-top: 10px;">Ver Reporte</button>
            </div>

            <div id="reporteContent"></div>
        </div>
    </div>

    <!-- MODALES -->

    <!-- Modal Crear Mesa -->
    <div class="modal" id="modalCrearMesa">
        <div class="modal-content">
           <div class="modal-header">
    <h2 id="tituloModalMesa">Nueva Mesa</h2>
                <button class="close-btn" onclick="closeModal('modalCrearMesa')">√ó</button>
            </div>
            <form id="formCrearMesa">
    <input type="hidden" id="mesaId">
    <div class="form-group">
                    <label>N√∫mero de Mesa</label>
                    <input type="text" id="numeroMesa" required>
                </div>
                <div class="form-group">
                    <label>Capacidad</label>
                    <input type="number" id="capacidadMesa" required min="1">
                </div>
                <button type="submit" class="btn" style="width:100%">Crear Mesa</button>
            </form>
        </div>
    </div>

    <!-- Modal Crear Empleado -->
    <div class="modal" id="modalCrearEmpleado">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuevo Empleado</h2>
                <button class="close-btn" onclick="closeModal('modalCrearEmpleado')">√ó</button>
            </div>
            <form id="formCrearEmpleado">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailEmpleado" required>
                </div>
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="nombreEmpleado" required>
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="rolEmpleado" required>
                        <option value="">Seleccionar...</option>
                        <option value="Mesero">Mesero</option>
                        <option value="Cocinero">Cocinero</option>
                        <option value="Cajero">Cajero</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width:100%">Crear Empleado</button>
            </form>
        </div>
    </div>

    <!-- Modal Crear Categor√≠a -->
    <div class="modal" id="modalCrearCategoria">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tituloModalCategoria">Nueva Categor√≠a</h2>
                <button class="close-btn" onclick="closeModal('modalCrearCategoria')">√ó</button>
            </div>
            <form id="formCategoria">
                <input type="hidden" id="categoriaId">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="nombreCategoria" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcionCategoria"></textarea>
                </div>
                <div class="form-group">
                    <label>Orden</label>
                    <input type="number" id="ordenCategoria" required min="1">
                </div>
                <button type="submit" class="btn" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Crear/Editar Producto -->
    <div class="modal" id="modalCrearProducto">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tituloModalProducto">Nuevo Producto</h2>
                <button class="close-btn" onclick="closeModal('modalCrearProducto')">√ó</button>
            </div>
            <form id="formProducto">
                <input type="hidden" id="productoId">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="nombreProducto" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcionProducto"></textarea>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="categoriaProducto" required></select>
                </div>
                <div class="form-group">
                    <label>Precio (S/.)</label>
                    <input type="number" id="precioProducto" step="0.01" required min="0">
                </div>
                <div class="form-group">
                    <label>URL Imagen</label>
                    <input type="text" id="urlImagenProducto">
                </div>
                <div class="form-group">
                    <label>Tiempo Preparaci√≥n (minutos)</label>
                    <input type="number" id="tiempoProducto" min="0">
                </div>
                <button type="submit" class="btn" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Crear Ingrediente -->
    <div class="modal" id="modalCrearIngrediente">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tituloModalIngrediente">Nuevo Ingrediente</h2>
                <button class="close-btn" onclick="closeModal('modalCrearIngrediente')">√ó</button>
            </div>
            <form id="formIngrediente">
                <input type="hidden" id="ingredienteId">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="nombreIngrediente" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcionIngrediente"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="alergenoIngrediente">
                        Es al√©rgeno
                    </label>
                </div>
                <button type="submit" class="btn" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
    
    <!-- Modal Asignar Ingrediente -->
<div class="modal" id="modalAsignarIngrediente">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Asignar Ingrediente a Producto</h2>
            <button class="close-btn" onclick="closeModal('modalAsignarIngrediente')">√ó</button>
        </div>
        <form id="formAsignarIngrediente">
            <div class="form-group">
                <label>Producto</label>
                <select id="productoAsignar" required></select>
            </div>
            <div class="form-group">
                <label>Ingrediente</label>
                <select id="ingredienteAsignar" required></select>
            </div>
            <div class="form-group">
                <label>Cantidad (ej: 200g, 2 unidades)</label>
                <input type="text" id="cantidadAsignar" required placeholder="200g">
            </div>
            <button type="submit" class="btn" style="width:100%">Asignar</button>
        </form>
    </div>
</div>
    <script>
        const API_URL = 'https://restaurantapi-latest.onrender.com/api';
        const token = localStorage.getItem('token');
        const nombreCompleto = localStorage.getItem('nombreCompleto');

        if (!token || localStorage.getItem('tipoUsuario') !== 'Admin') {
            window.location.href = 'index.html';
        }

        document.getElementById('adminInfo').textContent = `Bienvenido, ${nombreCompleto}`;
        document.getElementById('fechaReporte').valueAsDate = new Date();

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            switch(tabName) {
    case 'mesas': cargarMesas(); break;
    case 'empleados': cargarEmpleados(); break;
    case 'categorias': cargarCategorias(); break;
    case 'productos': cargarProductos(); cargarCategoriasSelect(); break;
    case 'ingredientes': cargarIngredientes(); break;
    case 'producto-ingredientes': cargarProductoIngredientes(); break;
}
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        function resetFormulario(formId) {
    document.getElementById(formId).reset();
    // Limpiar campos hidden de ID
    const inputs = document.getElementById(formId).querySelectorAll('input[type="hidden"]');
    inputs.forEach(input => input.value = '');
}

// Preparar formularios para crear (nuevo registro)
function prepararCrear(modalId, tituloId, titulo) {
    document.getElementById(tituloId).textContent = titulo;
    resetFormulario(modalId.replace('modal', 'form'));
    openModal(modalId);
}

        function mostrarAlerta(tipo, mensaje, clase) {
            const alert = document.getElementById(`alert${tipo}`);
            alert.className = `alert alert-${clase} show`;
            alert.textContent = mensaje;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // ========== MESAS ==========
        async function cargarMesas() {
            try {
                const response = await fetch(`${API_URL}/Mesas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const mesas = await response.json();
                
                document.querySelector('#tablaMesas tbody').innerHTML = mesas.map(m => `
                    <tr>
                        <td>${m.id}</td>
                        <td>${m.numeroMesa}</td>
                        <td><strong>${m.codigoMesa}</strong></td>
                        <td>${m.capacidad}</td>
                        <td><span class="badge ${m.activo ? 'badge-success' : 'badge-danger'}">
                            ${m.activo ? 'Activa' : 'Inactiva'}
                        </span></td>
                        <td class="actions-cell">
    <button class="btn btn-edit" onclick="editarMesa(${m.id})">‚úèÔ∏è</button>
    <button class="btn btn-delete" onclick="eliminarMesa(${m.id})">üóëÔ∏è</button>
</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('formCrearMesa').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('mesaId').value;
    const data = {
        id: parseInt(id) || 0,
        numeroMesa: document.getElementById('numeroMesa').value,
        capacidad: parseInt(document.getElementById('capacidadMesa').value),
        disponible: true,
        activo: true
    };

    const url = id ? `${API_URL}/Mesas/${id}` : `${API_URL}/Mesas`;
    const method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const mesa = await response.json();
                    document.getElementById('codigoMesaDisplay').innerHTML = `
                        <div class="code-display">
                            <h3>‚úÖ Mesa creada: ${mesa.numeroMesa}</h3>
                            <p>C√≥digo de acceso:</p>
                            <div class="code-value">${mesa.codigoMesa}</div>
                        </div>
                    `;
                    closeModal('modalCrearMesa');
                    e.target.reset();
                    cargarMesas();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function eliminarMesa(id) {
            if (!confirm('¬øEliminar esta mesa?')) return;
            try {
                await fetch(`${API_URL}/Mesas/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                cargarMesas();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function editarMesa(id) {
    try {
        const response = await fetch(`${API_URL}/Mesas`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const mesas = await response.json();
        const mesa = mesas.find(m => m.id === id);

        document.getElementById('tituloModalMesa').textContent = 'Editar Mesa';
        document.getElementById('mesaId').value = mesa.id;
        document.getElementById('numeroMesa').value = mesa.numeroMesa;
        document.getElementById('capacidadMesa').value = mesa.capacidad;
        
        openModal('modalCrearMesa');
    } catch (error) {
        console.error('Error:', error);
    }
}

        // ========== EMPLEADOS ==========
       async function cargarEmpleados() {
    try {
        // Obtener todos los usuarios de Identity
        const response = await fetch(`${API_URL}/Admin/usuarios`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            throw new Error('No se pudo cargar usuarios');
        }

        const data = await response.json();
        
        // Filtrar solo empleados (que tengan c√≥digo de empleado)
        const empleados = data.filter(u => u.codigoEmpleado);

        if (empleados.length === 0) {
            document.querySelector('#tablaEmpleados tbody').innerHTML = 
                '<tr><td colspan="6" style="text-align:center;padding:40px;color:#999;">No hay empleados registrados. Crea uno usando el bot√≥n "Nuevo Empleado"</td></tr>';
            return;
        }

        document.querySelector('#tablaEmpleados tbody').innerHTML = empleados.map(u => `
            <tr>
                <td><strong>${u.codigoEmpleado}</strong></td>
                <td>${u.nombreCompleto}</td>
                <td>${u.email}</td>
                <td>${u.roles ? u.roles.join(', ') : 'N/A'}</td>
                <td><span class="badge ${u.activo ? 'badge-success' : 'badge-danger'}">
                    ${u.activo ? 'Activo' : 'Inactivo'}
                </span></td>
                <td class="actions-cell">
                    <button class="btn btn-delete" onclick="desactivarEmpleado('${u.id}')">üîí</button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error:', error);
        document.querySelector('#tablaEmpleados tbody').innerHTML = 
            '<tr><td colspan="6" style="text-align:center;padding:20px;color:#f44336;">Error al cargar empleados. Verifica que el endpoint est√© disponible.</td></tr>';
    }
}

        document.getElementById('formCrearEmpleado').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                email: document.getElementById('emailEmpleado').value,
                nombreCompleto: document.getElementById('nombreEmpleado').value,
                rol: document.getElementById('rolEmpleado').value
            };

            try {
                const response = await fetch(`${API_URL}/Auth/register-empleado`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('codigoEmpleadoDisplay').innerHTML = `
                        <div class="code-display">
                            <h3>‚úÖ Empleado registrado</h3>
                            <p>${result.email} - ${result.rol}</p>
                            <div class="code-value">${result.codigoEmpleado}</div>
                        </div>
                    `;
                    closeModal('modalCrearEmpleado');
                    e.target.reset();
                    cargarEmpleados();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // ========== CATEGOR√çAS ==========
        async function cargarCategorias() {
            try {
                const response = await fetch(`${API_URL}/Categorias`);
                const categorias = await response.json();
                
                document.querySelector('#tablaCategorias tbody').innerHTML = categorias.map(c => `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.nombre}</td>
                        <td>${c.descripcion || '-'}</td>
                        <td>${c.orden}</td>
                        <td><span class="badge ${c.activo ? 'badge-success' : 'badge-danger'}">
                            ${c.activo ? 'Activa' : 'Inactiva'}
                        </span></td>
                        <td class="actions-cell">
                            <button class="btn btn-edit" onclick="editarCategoria(${c.id})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="eliminarCategoria(${c.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarCategoriasSelect() {
            try {
                const response = await fetch(`${API_URL}/Categorias`);
                const categorias = await response.json();
                
                document.getElementById('categoriaProducto').innerHTML = 
                    '<option value="">Seleccionar...</option>' +
                    categorias.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('formCategoria').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('categoriaId').value;
            const data = {
                id: parseInt(id) || 0,
                nombre: document.getElementById('nombreCategoria').value,
                descripcion: document.getElementById('descripcionCategoria').value,
                orden: parseInt(document.getElementById('ordenCategoria').value),
                activo: true
            };

            const url = id ? `${API_URL}/Categorias/${id}` : `${API_URL}/Categorias`;
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    mostrarAlerta('Categorias', 'Categor√≠a guardada', 'success');
                    closeModal('modalCrearCategoria');
                    e.target.reset();
                    cargarCategorias();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function editarCategoria(id) {
            try {
                const response = await fetch(`${API_URL}/Categorias`);
                const categorias = await response.json();
                const categoria = categorias.find(c => c.id === id);

                document.getElementById('tituloModalCategoria').textContent = 'Editar Categor√≠a';
                document.getElementById('categoriaId').value = categoria.id;
                document.getElementById('nombreCategoria').value = categoria.nombre;
                document.getElementById('descripcionCategoria').value = categoria.descripcion || '';
                document.getElementById('ordenCategoria').value = categoria.orden;
                
                openModal('modalCrearCategoria');
            } catch (error) {
console.error('Error:', error);
}
}

async function eliminarCategoria(id) {
        if (!confirm('¬øEliminar esta categor√≠a?')) return;
        try {
            await fetch(`${API_URL}/Categorias/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            cargarCategorias();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // ========== PRODUCTOS ==========
    async function cargarProductos() {
        try {
            const response = await fetch(`${API_URL}/Productos`);
            const productos = await response.json();
            
            document.querySelector('#tablaProductos tbody').innerHTML = productos.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.categoriaNombre}</td>
                    <td>S/. ${p.precio.toFixed(2)}</td>
                    <td><span class="badge ${p.disponible ? 'badge-success' : 'badge-danger'}">
                        ${p.disponible ? 'S√≠' : 'No'}
                    </span></td>
                    <td class="actions-cell">
                        <button class="btn btn-edit" onclick="editarProducto(${p.id})">‚úèÔ∏è</button>
                        <button class="btn btn-delete" onclick="eliminarProducto(${p.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    document.getElementById('formProducto').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('productoId').value;
        const data = {
            id: parseInt(id) || 0,
            nombre: document.getElementById('nombreProducto').value,
            descripcion: document.getElementById('descripcionProducto').value,
            categoriaId: parseInt(document.getElementById('categoriaProducto').value),
            precio: parseFloat(document.getElementById('precioProducto').value),
            urlImagen: document.getElementById('urlImagenProducto').value,
            tiempoPreparacion: parseInt(document.getElementById('tiempoProducto').value) || 0,
            disponible: true
        };

        const url = id ? `${API_URL}/Productos/${id}` : `${API_URL}/Productos`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                mostrarAlerta('Productos', 'Producto guardado', 'success');
                closeModal('modalCrearProducto');
                e.target.reset();
                cargarProductos();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    async function editarProducto(id) {
        try {
            const response = await fetch(`${API_URL}/Productos`);
            const productos = await response.json();
            const producto = productos.find(p => p.id === id);

            document.getElementById('tituloModalProducto').textContent = 'Editar Producto';
            document.getElementById('productoId').value = producto.id;
            document.getElementById('nombreProducto').value = producto.nombre;
            document.getElementById('descripcionProducto').value = producto.descripcion || '';
            document.getElementById('categoriaProducto').value = producto.categoriaId;
            document.getElementById('precioProducto').value = producto.precio;
            document.getElementById('urlImagenProducto').value = producto.urlImagen || '';
            document.getElementById('tiempoProducto').value = producto.tiempoPreparacion;
            
            openModal('modalCrearProducto');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function eliminarProducto(id) {
        if (!confirm('¬øEliminar este producto?')) return;
        try {
            await fetch(`${API_URL}/Productos/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            cargarProductos();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // ========== INGREDIENTES ==========
    async function cargarIngredientes() {
        try {
            const response = await fetch(`${API_URL}/Ingredientes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const ingredientes = await response.json();
            
            document.querySelector('#tablaIngredientes tbody').innerHTML = ingredientes.map(i => `
                <tr>
                    <td>${i.id}</td>
                    <td>${i.nombre}</td>
                    <td>${i.descripcion || '-'}</td>
                    <td><span class="badge ${i.alergeno ? 'badge-danger' : 'badge-success'}">
                        ${i.alergeno ? '‚ö†Ô∏è S√≠' : 'No'}
                    </span></td>
                    <td class="actions-cell">
                        <button class="btn btn-edit" onclick="editarIngrediente(${i.id})">‚úèÔ∏è</button>
                        <button class="btn btn-delete" onclick="eliminarIngrediente(${i.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    document.getElementById('formIngrediente').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('ingredienteId').value;
        const data = {
            id: parseInt(id) || 0,
            nombre: document.getElementById('nombreIngrediente').value,
            descripcion: document.getElementById('descripcionIngrediente').value,
            alergeno: document.getElementById('alergenoIngrediente').checked,
            activo: true
        };

        const url = id ? `${API_URL}/Ingredientes/${id}` : `${API_URL}/Ingredientes`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                mostrarAlerta('Ingredientes', 'Ingrediente guardado', 'success');
                closeModal('modalCrearIngrediente');
                e.target.reset();
                cargarIngredientes();
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    async function editarIngrediente(id) {
        try {
            const response = await fetch(`${API_URL}/Ingredientes`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const ingredientes = await response.json();
            const ingrediente = ingredientes.find(i => i.id === id);

            document.getElementById('tituloModalIngrediente').textContent = 'Editar Ingrediente';
            document.getElementById('ingredienteId').value = ingrediente.id;
            document.getElementById('nombreIngrediente').value = ingrediente.nombre;
            document.getElementById('descripcionIngrediente').value = ingrediente.descripcion || '';
            document.getElementById('alergenoIngrediente').checked = ingrediente.alergeno;
            
            openModal('modalCrearIngrediente');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function eliminarIngrediente(id) {
        if (!confirm('¬øEliminar este ingrediente?')) return;
        try {
            await fetch(`${API_URL}/Ingredientes/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            cargarIngredientes();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // ========== PRODUCTO-INGREDIENTES ==========
let asignaciones = [];

async function cargarProductoIngredientes() {
    try {
        // Cargar productos y ingredientes para los selects
        const prodResponse = await fetch(`${API_URL}/Productos`);
        const productos = await prodResponse.json();
        
        const ingResponse = await fetch(`${API_URL}/Ingredientes`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const ingredientes = await ingResponse.json();

        // Llenar select de filtro
        document.getElementById('filtroProducto').innerHTML = 
            '<option value="">Todos los productos</option>' +
            productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');

        // Llenar selects del modal
        document.getElementById('productoAsignar').innerHTML = 
            '<option value="">Seleccionar...</option>' +
            productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');

        document.getElementById('ingredienteAsignar').innerHTML = 
            '<option value="">Seleccionar...</option>' +
            ingredientes.map(i => `<option value="${i.id}">${i.nombre}${i.alergeno ? ' ‚ö†Ô∏è' : ''}</option>`).join('');

        // Cargar asignaciones actuales
        await cargarAsignaciones();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function cargarAsignaciones() {
    try {
        const response = await fetch(`${API_URL}/Productos`);
        const productos = await response.json();
        
        // Extraer todas las asignaciones
        asignaciones = [];
        productos.forEach(producto => {
            if (producto.ingredientes && producto.ingredientes.length > 0) {
                producto.ingredientes.forEach(ing => {
                    asignaciones.push({
                        productoId: producto.id,
                        productoNombre: producto.nombre,
                        ingredienteId: ing.id,
                        ingredienteNombre: ing.nombre,
                        cantidad: ing.cantidad,
                        alergeno: ing.alergeno
                    });
                });
            }
        });

        filtrarAsignaciones();
    } catch (error) {
        console.error('Error:', error);
    }
}

function filtrarAsignaciones() {
    const filtro = document.getElementById('filtroProducto').value;
    const filtradas = filtro ? asignaciones.filter(a => a.productoId == filtro) : asignaciones;

    if (filtradas.length === 0) {
        document.querySelector('#tablaProductoIngredientes tbody').innerHTML = 
            '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">No hay ingredientes asignados</td></tr>';
        return;
    }

    document.querySelector('#tablaProductoIngredientes tbody').innerHTML = filtradas.map(a => `
        <tr>
            <td>${a.productoNombre}</td>
            <td>${a.ingredienteNombre}</td>
            <td>${a.cantidad}</td>
            <td><span class="badge ${a.alergeno ? 'badge-danger' : 'badge-success'}">
                ${a.alergeno ? '‚ö†Ô∏è S√≠' : 'No'}
            </span></td>
            <td class="actions-cell">
                <button class="btn btn-delete" onclick="eliminarAsignacion(${a.productoId}, ${a.ingredienteId})">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');
}

document.getElementById('formAsignarIngrediente').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        productoId: parseInt(document.getElementById('productoAsignar').value),
        ingredienteId: parseInt(document.getElementById('ingredienteAsignar').value),
        cantidad: document.getElementById('cantidadAsignar').value
    };

    try {
        const response = await fetch(`${API_URL}/Ingredientes/AsignarAProducto`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            mostrarAlerta('ProductoIngredientes', 'Ingrediente asignado correctamente', 'success');
            closeModal('modalAsignarIngrediente');
            e.target.reset();
            cargarAsignaciones();
        } else {
            const error = await response.json();
            mostrarAlerta('ProductoIngredientes', error.message || 'Error al asignar', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('ProductoIngredientes', 'Error de conexi√≥n', 'error');
    }
});

async function eliminarAsignacion(productoId, ingredienteId) {
    if (!confirm('¬øEliminar esta asignaci√≥n?')) return;
    
    try {
        // Buscar el ID de la relaci√≥n (necesitas agregarlo al objeto asignaciones)
        const response = await fetch(`${API_URL}/Ingredientes/RemoverDeProducto/${productoId}/${ingredienteId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            mostrarAlerta('ProductoIngredientes', 'Asignaci√≥n eliminada', 'success');
            cargarAsignaciones();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar la asignaci√≥n');
    }
}

    // ========== REPORTES ==========
    async function cargarReporte() {
        const fecha = document.getElementById('fechaReporte').value;
        
        try {
            const response = await fetch(`${API_URL}/Pedidos/admin/reporte/${fecha}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const reporte = await response.json();
            
            document.getElementById('reporteContent').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700;">${reporte.totalPedidos}</div>
                        <div>Total Pedidos</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700;">${reporte.pedidosPendientes}</div>
                        <div>Pendientes</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700;">${reporte.pedidosCompletados}</div>
                        <div>Completados</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700;">S/. ${reporte.totalVentas.toFixed(2)}</div>
                        <div>Total Ventas</div>
                    </div>
                </div>
                
                ${reporte.pedidos.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Mesa</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reporte.pedidos.map(p => `
                                <tr>
                                    <td>${p.numeroPedido}</td>
                                    <td>${p.numeroMesa}</td>
                                    <td>${new Date(p.fechaHoraPedido).toLocaleTimeString()}</td>
                                    <td>${p.estado}</td>
                                    <td>S/. ${p.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p style="text-align:center;padding:40px;">No hay pedidos en esta fecha</p>'}
            `;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    // Cargar datos iniciales
    cargarMesas();
</script>

</body>
</html>


